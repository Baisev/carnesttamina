<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gesti√≥n de Productos - Carnes Ttami√±a</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="css/footer.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script type="module" src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module" src="js/navbarEmpleado.js"></script>
  <script type="module" src="js/searchbar.js"></script>

  <style>
    /* üí¨ Mensaje flotante */
    #mensaje {
      position: fixed;
      top: 15px;
      right: 15px;
      background: #323232;
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }
    #mensaje.mostrar {
      opacity: 1;
    }

    /* ESTILOS PARA FORMULARIO */
    main {
      max-width: 1000px;
      margin: 40px auto;
      padding: 0 20px;
    }

    #formProducto {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }

    #formProducto label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
    }

    #formProducto input,
    #formProducto select,
    #formProducto textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    
    /* Estilo especial para el input de archivo */
    #formProducto input[type="file"] {
      padding: 8px;
      background: #fff;
    }

    #formProducto button {
      background: #c00;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.3s ease;
    }

    #formProducto button:hover {
      background: #a00;
    }

    /* ESTILOS PARA LISTA DE PRODUCTOS */
    .producto-item {
      border: 1px solid #ddd;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .producto-item label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
    }
    
    .producto-item img {
        width: 100px; 
        height: 100px; 
        object-fit: cover; 
        border-radius: 5px;
        border: 1px solid #eee;
    }

    .producto-item input,
    .producto-item select,
    .producto-item textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }

    .producto-item textarea {
      height: 80px;
      resize: vertical;
    }

    .btn-editar {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    .btn-editar:hover {
      background: #218838;
    }

    .btn-eliminar {
      background: #b71c1c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-eliminar:hover {
      background: #9a1a1a;
    }

    .producto-item small {
      color: #666;
      font-size: 0.9em;
    }

    .lista-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
      flex-wrap: wrap;
    }

    #edit-search{
      flex:1;
      max-width:260px;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
    }

    .btn-excel{
      background:#1f7a3d;
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn-excel:disabled{ opacity:.6; cursor:not-allowed; }

    /* === GRID DE 2 COLUMNAS === */
    .gestion-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-top: 20px;
    }

    /* En m√≥viles se vuelve una columna */
    @media (max-width: 900px) {
      .gestion-grid {
        grid-template-columns: 1fr;
      }
    }

    /* === CARD AUDITOR√çA === */
    .auditoria-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #ddd;
    }

    /* Ajustar inputs */
    .auditoria-card input,
    .auditoria-card select,
    .auditoria-card textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #bbb;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 15px;
    }

    .btn-aud {
      background: #c30000;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
    }

    .btn-aud:hover {
      background: #9e0000;
    }

    /* === BUSCADOR AUDITOR√çA === */
    .aud-search-container{
      position:relative;
      margin-top:10px;
    }

    #aud-search{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:15px;
    }

    .aud-results{
      position:absolute;
      left:0;
      right:0;
      top:100%;
      margin-top:4px;
      background:#fff;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      max-height:220px;
      overflow-y:auto;
      display:none;
      z-index:1000;
    }

    .aud-item{
      padding:8px 10px;
      cursor:pointer;
    }

    .aud-item:hover{
      background:#f2f2f2;
    }
    /* Nota / globo para el empleado */
.info-bubble{
  background:#fff7e6;
  border:1px solid #f0c36d;
  border-left-width:5px;
  border-radius:10px;
  padding:12px 16px;
  margin-bottom:15px;
  display:flex;
  align-items:flex-start;
  gap:10px;
  font-size:14px;
}

.info-bubble i{
  margin-top:2px;
  color:#e0a100;
}

.info-bubble strong{
  display:block;
  margin-bottom:3px;
}

  </style>
</head>
<body>

<!-- NAVBAR -->
<header class="navbar">
  <div class="navbar-container">
    <!-- LOGO + barra de b√∫squeda -->
    <div class="navbar-left">
      <h1 class="navbar-logo">Carnes Ttami√±a</h1>
      <div class="navbar-search">
        <input type="text" placeholder="Busca aqu√≠ tus productos..." />
        <button><i class="fa fa-search"></i></button>
      </div>
    </div>

    <!-- MEN√ö DE NAVEGACI√ìN -->
    <nav class="navbar-right">
      <ul>
        <li><a href="pag_principal.html"><i class="fa fa-home"></i> Inicio</a></li>

        <li class="dropdown align-right">
          <a href="#"><i class="fa fa-user"></i> Bienvenido</a>
          <ul class="dropdown-menu">
            <li><a href="#"><i class="fa fa-id-card"></i> Mi cuenta</a></li>
            <li><a href="login.html"><i class="fa fa-sign-in-alt"></i> Iniciar sesi√≥n</a></li>
            <li class="no-cuenta">¬øNo tienes cuenta?
              <a href="registro.html" class="crear-cuenta">Cr√©ala aqu√≠</a>
            </li>
          </ul>
        </li>

        <!-- Men√∫ Categor√≠as -->
        <li class="dropdown">
          <a href="#"><i class="fa fa-cut"></i> Categor√≠as <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu">
            <li><a href="vacuno.html">Vacuno</a></li>
            <li><a href="ave.html">Ave</a></li>
            <li><a href="cerdo.html">Cerdo</a></li>
            <li><a href="todo_asado.html">Todo para el asado</a></li>
            <li><a href="packs.html">Packs</a></li>
          </ul>
        </li>

        <li class="cart-icon">
          <a href="carrito.html">
            <i class="fa fa-shopping-cart"></i>
            <span class="cart-count">0</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>

<main>
  <div style="margin-top: 40px;" class="info-bubble">
  <i class="fa-solid fa-circle-info"></i>
  <div>
    <strong>Nota para el empleado</strong>
    Cada vez que agregues o edites un producto en esta p√°gina, 
    recuerda registrar su auditor√≠a en el panel <em>"Registrar auditor√≠a"</em> 
    (a la derecha) solo tienes que buscar el producto por su nombre y rellenar el formulario. Esa informaci√≥n se usar√° para el Excel de inventario y control semanal.
  </div>
</div>
  <h2 style="margin-top:50px;">Gesti√≥n de Productos</h2>

  <div class="gestion-grid">

    <!-- COLUMNA IZQUIERDA: AGREGAR PRODUCTO -->
    <section id="formulario">
      <h3>Agregar producto</h3>
      <form id="formProducto" autocomplete="off">

        <label for="nombre">Nombre del producto:</label>
        <input type="text" id="nombre" name="nombre" placeholder="Nombre del producto" required />

        <label for="imagen">Imagen del producto:</label>
        <input type="file" id="imagen" name="imagen" accept="image/*" required />

        <label for="categoria">Categor√≠a:</label>
        <select id="categoria" name="categoria" required>
          <option value="">Selecciona una categor√≠a</option>
          <option value="vacuno">üêÑ Vacuno</option>
          <option value="ave">üêî Ave</option>
          <option value="cerdo">üêñ Cerdo</option>
          <option value="Todo para el asado">ü•© Todo para el asado</option>
          <option value="packs">üì¶ Packs</option>
        </select>

        <label for="precio">Precio ($):</label>
        <input type="text" id="precio" name="precio" placeholder="Precio ($)" inputmode="decimal" required />

        <label for="stock">Stock:</label>
        <input type="text" id="stock" name="stock" placeholder="Stock disponible" inputmode="decimal" required />

        <label for="descripcion">Descripci√≥n:</label>
        <textarea id="descripcion" name="descripcion" placeholder="Descripci√≥n (opcional)"></textarea>

        <button type="submit">Guardar</button>
      </form>
    </section>

    <section id="auditoria">
      <h3>Registrar auditor√≠a</h3>

      <div class="aud-search-container">
        <input type="text" id="aud-search" placeholder="Buscar producto para auditor√≠a...">
        <div id="aud-search-results" class="aud-results"></div>
      </div>

      <div id="aud-form" class="auditoria-card" style="display:none; margin-top:20px;">
        <label>Semana:</label>
        <input id="aud-semana" type="text" placeholder="Ej: sem1">

        <label>Stock sistema:</label>
        <input id="aud-stock-sistema" type="number" readonly>

        <label>Stock f√≠sico:</label>
        <input id="aud-stock-fisico" type="number">

        <label>Compra:</label>
        <input id="aud-compra" type="number" value="0">

        <label>Venta:</label>
        <input id="aud-venta" type="number" value="0">

        <label>Ajuste auditor√≠a:</label>
        <input id="aud-ajuste" type="number" value="0">

        <label>Stock m√≠nimo:</label>
        <input id="aud-minimo" type="number" value="0">

        <label>Precio compra unitario ($):</label>
        <input id="aud-precio-compra" type="number" step="0.01" value="0">

        <label>Precio venta unitario ($):</label>
        <input id="aud-precio-venta" type="number" step="0.01" value="0">


        <label>Observaci√≥n:</label>
        <textarea id="aud-observacion" placeholder="Opcional"></textarea>

        <button id="btn-guardar-auditoria" class="btn-aud">Guardar Auditor√≠a</button>
      </div>
    </section>

  </div>

  <section id="lista">
    <div class="lista-toolbar">
      <h3>Lista de productos</h3>
      <input type="text" id="edit-search" placeholder="Buscar en la lista...">
      <button id="btn-exportar-inventario" class="btn-excel" title="Exportar inventario a Excel">
        <i class="fa-solid fa-file-excel"></i> Exportar Excel
      </button>
    </div>

    <div id="productos">Cargando productos...</div>
  </section>
</main>

<div id="mensaje"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script type="module" src="js/protegerEmpleado.js"></script>
<script type="module" src="js/navbarEmpleado.js"></script>
<script type="module" src="js/navbar.js"></script>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  const SUPABASE_URL = 'https://bagilcaibwidyewiqqzd.supabase.co'
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhZ2lsY2FpYndpZHlld2lxcXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMjY3NDEsImV4cCI6MjA3NDYwMjc0MX0.VsVsH8c9fpjKxgmuNWYUCqE8e8DDcXicUELTexNJaAU'
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

  const form = document.getElementById('formProducto')
  const contenedor = document.getElementById('productos')
  const mensaje = document.getElementById('mensaje')

  function mostrarMensaje(texto, color = "green") {
    mensaje.textContent = texto
    mensaje.style.background = color === "red" ? "#b71c1c" : "#323232"
    mensaje.classList.add("mostrar")
    setTimeout(() => mensaje.classList.remove("mostrar"), 2000)
  }

  function autoAnchoColumnas(rows){
    if(!rows?.length) return [];
    const headers = Object.keys(rows[0]);
    return headers.map(h=>{
      const maxLen = Math.max(h.length, ...rows.map(r=>String(r[h] ?? '').length));
      return { wch: Math.min(40, Math.max(10, maxLen + 2)) };
    });
  }

  function nombreArchivoInventario(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `Inventario_Carnes_Ttamina_${yyyy}-${mm}-${dd}_${hh}${mi}.xlsx`;
  }

async function obtenerInventario(){
  const { data, error } = await supabase
    .from('producto')
    .select('producto_id, nombre, categoria, unidad, precio, stock, activo, creado_en')
    .order('stock',{ ascending:true }); 

  if(error) throw error;

  return (data || []).map(p=>{
    const stockNum = Number(p.stock ?? 0);
    return {
      'ID'              : p.producto_id,
      'Producto'        : p.nombre ?? '',
      'Categor√≠a'       : p.categoria ?? '',
      'Unidad'          : p.unidad ?? '',
      'Precio ($)'      : Number(p.precio ?? 0),
      'Stock actual'    : stockNum,               
      'Unidades vendidas': '' ,      
      'Stock bajo (<=10)': stockNum <= 10 ? 'S√≠' : 'No', 
      'Activo'          : (p.activo === true ? 'S√≠' : 'No'),
      'Creado en'       : p.creado_en ? new Date(p.creado_en).toLocaleString() : ''
    };
  });
}



  async function obtenerAuditorias(){
  const { data: productos, error: errorProd } = await supabase
    .from('producto')
    .select('producto_id, nombre, categoria');

  if (errorProd) throw errorProd;

  const mapaProd = new Map((productos || []).map(p => [p.producto_id, p]));

  const { data, error } = await supabase
    .from('producto_auditoria')
    .select('*')
    .order('creado_en', { ascending: true });  

  if (error) throw error;

return (data || []).map((aud, index) => {
  const prod = mapaProd.get(aud.producto_id) || {};
  const row = index + 2; 

  const stockSistema = Number(aud.stock_sistema ?? 0);
  const stockFisico  = Number(aud.stock_fisico ?? 0);
  const diferencia   = stockFisico - stockSistema;
  const compra       = Number(aud.compra ?? 0);
  const venta        = Number(aud.venta ?? 0);
  const precioCompra = Number(aud.precio_compra ?? 0);
  const precioVenta  = Number(aud.precio_venta ?? 0);

  return {
    'ID auditor√≠a' : aud.auditoria_id ?? null,
    'ID producto'  : aud.producto_id,
    'Producto'     : prod.nombre ?? '',
    'Categor√≠a'    : prod.categoria ?? '',
    'Semana'       : aud.semana ?? '',

    'Stock sistema': stockSistema,
    'Stock f√≠sico' : stockFisico,
    'Diferencia'   : diferencia,

    'Compra (unidades)': compra,
    'Venta (unidades)' : venta,

    'Precio compra unitario ($)': precioCompra,
    'Precio venta unitario ($)' : precioVenta,

    'Total compra ($)' : { f: `H${row}*I${row}` },
    'Total venta ($)'  : { f: `J${row}*K${row}` },
    'Utilidad bruta ($)': { f: `M${row}-L${row}` },

'Diferencia valorizada ($)' : { f: `(G${row}-F${row})*L${row}` },

'% Variaci√≥n inventario' : { 
  f: `IF(F${row}<>0,(G${row}-F${row})/F${row},"")` 
},

    'Observaci√≥n'  : aud.observacion ?? '',
    'Registrado en': aud.creado_en ? new Date(aud.creado_en).toLocaleString() : ''
  };
});
}

async function exportarExcelInventario(){
  const btn = document.getElementById('btn-exportar-inventario');
  btn.disabled = true;
  const old = btn.innerHTML;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generando...';

  try{
    const filasInv = await obtenerInventario();
    const filasAud = await obtenerAuditorias();
    const wb = XLSX.utils.book_new();

   if (filasInv.length > 0) {
      const wsInv = XLSX.utils.json_to_sheet(filasInv);
      wsInv['!cols'] = autoAnchoColumnas(filasInv);

      const headersInv = Object.keys(filasInv[0]);
      const lastColInv = XLSX.utils.encode_col(headersInv.length - 1);
      const lastRowInv = filasInv.length + 1;

      if (!wsInv['!ref']) {
        wsInv['!ref'] = `A1:${lastColInv}${lastRowInv}`;
      }

      wsInv['!autofilter'] = { ref: wsInv['!ref'] }; 

      XLSX.utils.book_append_sheet(wb, wsInv, 'Inventario');

const wsDashboard = {};


wsDashboard["A1"] = { t: "s", v: "Indicador" };
wsDashboard["B1"] = { t: "s", v: "Valor" };

wsDashboard["A2"] = { t: "s", v: "Total de productos" };
wsDashboard["B2"] = { t: "n", f: "COUNTA(Inventario!A:A)-1" };

wsDashboard["A3"] = { t: "s", v: "Stock total" };
wsDashboard["B3"] = { t: "n", f: "SUM(Inventario!F:F)" };

wsDashboard["A4"] = { t: "s", v: "Productos con stock bajo (<=10)" };
wsDashboard["B4"] = { t: "n", f: 'COUNTIF(Inventario!F:F,"<=10")' };

wsDashboard["A5"] = { t: "s", v: "Total compras ($)" };
wsDashboard["B5"] = { t: "n", f: "SUM(Auditor√≠a!M:M)" };

wsDashboard["A6"] = { t: "s", v: "Total ventas ($)" };
wsDashboard["B6"] = { t: "n", f: "SUM(Auditor√≠a!N:N)" };

wsDashboard["A7"] = { t: "s", v: "Utilidad bruta total ($)" };
wsDashboard["B7"] = { t: "n", f: "SUM(Auditor√≠a!O:O)" };

wsDashboard["A8"] = { t: "s", v: "Utilidad promedio ($)" };
wsDashboard["B8"] = { t: "n", f: "AVERAGE(Auditor√≠a!O:O)" };

wsDashboard["A10"] = { t: "s", v: "Top 5 productos m√°s vendidos" };

wsDashboard["A11"] = { t: "s", v: "Producto" };
wsDashboard["B11"] = { t: "s", v: "Unidades vendidas" };

wsDashboard["A12"] = { t: "s", f: "INDEX(Auditor√≠a!C:C, MATCH(LARGE(Auditor√≠a!J:J,1), Auditor√≠a!J:J,0))" };
wsDashboard["B12"] = { t: "n", f: "LARGE(Auditor√≠a!J:J,1)" };

wsDashboard["A13"] = { t: "s", f: "INDEX(Auditor√≠a!C:C, MATCH(LARGE(Auditor√≠a!J:J,2), Auditor√≠a!J:J,0))" };
wsDashboard["B13"] = { t: "n", f: "LARGE(Auditor√≠a!J:J,2)" };

wsDashboard["A14"] = { t: "s", f: "INDEX(Auditor√≠a!C:C, MATCH(LARGE(Auditor√≠a!J:J,3), Auditor√≠a!J:J,0))" };
wsDashboard["B14"] = { t: "n", f: "LARGE(Auditor√≠a!J:J,3)" };

wsDashboard["A15"] = { t: "s", f: "INDEX(Auditor√≠a!C:C, MATCH(LARGE(Auditor√≠a!J:J,4), Auditor√≠a!J:J,0))" };
wsDashboard["B15"] = { t: "n", f: "LARGE(Auditor√≠a!J:J,4)" };

wsDashboard["A16"] = { t: "s", f: "INDEX(Auditor√≠a!C:C, MATCH(LARGE(Auditor√≠a!J:J,5), Auditor√≠a!J:J,0))" };
wsDashboard["B16"] = { t: "n", f: "LARGE(Auditor√≠a!J:J,5)" };

wsDashboard["!ref"] = "A1:B16";

wsDashboard["!cols"] = [
  { wch: 35 },
  { wch: 22 }
];



wsDashboard["!cols"] = [
  { wch: 35 }, 
  { wch: 20 }  
];

wsDashboard["A1"].s = { font: { bold: true } };
wsDashboard["B1"].s = { font: { bold: true } };

wsDashboard["A10"].s = { font: { bold: true } };
wsDashboard["A11"].s = { font: { bold: true } };
wsDashboard["B11"].s = { font: { bold: true } };

XLSX.utils.book_append_sheet(wb, wsDashboard, "Dashboard");

    }

    if (filasAud.length > 0) {
      const wsAud = XLSX.utils.json_to_sheet(filasAud);
      wsAud['!cols'] = autoAnchoColumnas(filasAud);

      const headersAud = Object.keys(filasAud[0]);
      const lastColAud = XLSX.utils.encode_col(headersAud.length - 1);
      const lastRowAud = filasAud.length + 1;
      wsAud['!autofilter'] = { ref: `A1:${lastColAud}${lastRowAud}` };

      XLSX.utils.book_append_sheet(wb, wsAud, 'Auditor√≠a');
    }

    XLSX.writeFile(wb, nombreArchivoInventario());
  }catch(e){
    console.error(e);
    alert('No se pudo generar el Excel. Revisa la consola para m√°s detalles.');
  }finally{
    btn.disabled = false;
    btn.innerHTML = old;
  }
}




  document.getElementById('btn-exportar-inventario')
    ?.addEventListener('click', exportarExcelInventario);

  async function cargarProductos() {
    const { data: productos, error } = await supabase
      .from('producto')
      .select('*')
      .eq('activo', true)
      .order('producto_id', { ascending: true })

    if (error) {
      contenedor.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`
      return
    }

    if (!productos || productos.length === 0) {
      contenedor.innerHTML = '<p>No hay productos registrados.</p>'
      return
    }

    contenedor.innerHTML = productos.map(p => `
      <div class="producto-item" id="prod-${p.producto_id}">
        <img src="${p.imagen_url || 'https://via.placeholder.com/150?text=Sin+Imagen'}" alt="${p.nombre}">
        <br>
        <strong>
          <a href="producto.html?id=${p.producto_id}" class="link-producto" target="_blank">
            ${p.nombre}
          </a>
        </strong><br>
        <small>ID: ${p.producto_id}</small><br>

        <label>Categor√≠a:</label>
        <select id="categoria-${p.producto_id}" class="categoria-editar">
          <option value="vacuno" ${p.categoria === 'vacuno' ? 'selected' : ''}>üêÑ Vacuno</option>
          <option value="ave" ${p.categoria === 'ave' ? 'selected' : ''}>üêî Ave</option>
          <option value="cerdo" ${p.categoria === 'cerdo' ? 'selected' : ''}>üêñ Cerdo</option>
          <option value="Todo para el asado" ${p.categoria === 'Todo para el asado' ? 'selected' : ''}>ü•© Miscel√°neos</option>
          <option value="packs" ${p.categoria === 'packs' ? 'selected' : ''}>üì¶ Packs</option>
        </select>
        
        <label>Precio ($):</label>
        <input type="number" id="precio-${p.producto_id}" value="${p.precio}" step="0.01">
        
        <label>Stock:</label>
        <input type="number" id="stock-${p.producto_id}" value="${p.stock}" step="0.001">
        
        <label>Descripci√≥n:</label>
        <textarea id="desc-${p.producto_id}">${p.descripcion ?? ''}</textarea>
        
        <label>Cambiar imagen (opcional):</label>
        <input type="file" id="imagen-${p.producto_id}" accept="image/*">
        
        <br><br>
        <button class="btn-editar" data-id="${p.producto_id}">‚úèÔ∏è Guardar cambios</button>
        <button class="btn-eliminar" data-id="${p.producto_id}">üóëÔ∏è Eliminar</button>
      </div>
    `).join('')

    document.querySelectorAll('.btn-editar').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id
        await editarProducto(id)
      })
    })

    document.querySelectorAll('.btn-eliminar').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id
        if (confirm('¬øSeguro que quieres eliminar este producto?')) {
          await eliminarProducto(id)
        }
      })
    })
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault()

    const nombre = document.getElementById('nombre').value.trim()
    const descripcion = document.getElementById('descripcion').value.trim() || null
    const precio = parseFloat(document.getElementById('precio').value.replace(',', '.')) || 0
    const stock = parseFloat(document.getElementById('stock').value.replace(',', '.')) || 0
    const categoria = document.getElementById('categoria').value
    const file = document.getElementById('imagen').files[0]

    if (!nombre) return mostrarMensaje('Ingrese un nombre', 'red')
    if (isNaN(precio) || isNaN(stock)) return mostrarMensaje('Precio o stock inv√°lido', 'red')
    if (!categoria) return mostrarMensaje('Selecciona una categor√≠a', 'red')
    if (!file) return mostrarMensaje('Debes seleccionar una imagen', 'red')

    let finalImageUrl = null
    try {
      const filePath = `public/${Date.now()}-${file.name}`

      const { error: uploadError } = await supabase.storage
        .from('imagcar')
        .upload(filePath, file, { upsert: false })

      if (uploadError) throw uploadError

      const { data: urlData } = supabase.storage.from('imagcar').getPublicUrl(filePath)
      finalImageUrl = urlData.publicUrl

    } catch (error) {
      mostrarMensaje('Error al subir la imagen: ' + error.message, 'red')
      return
    }

    const { error: insertError } = await supabase.from('producto').insert([{ 
      nombre, descripcion, precio, stock, categoria, imagen_url: finalImageUrl 
    }])

    if (insertError) return mostrarMensaje('Error: ' + insertError.message, 'red')

    mostrarMensaje('‚úÖ Producto agregado correctamente')
    form.reset()
    cargarProductos()
  })

  async function editarProducto(id) {
    const descripcion = document.getElementById(`desc-${id}`).value.trim() || null
    const precio = parseFloat(document.getElementById(`precio-${id}`).value.replace(',', '.')) || 0
    const stock = parseFloat(document.getElementById(`stock-${id}`).value.replace(',', '.')) || 0
    const categoria = document.getElementById(`categoria-${id}`).value
    const newFile = document.getElementById(`imagen-${id}`).files[0]

    let updateObject = { descripcion, precio, stock, categoria }

    if (newFile) {
      try {
        const filePath = `public/${Date.now()}-${newFile.name}`
        const { error: uploadError } = await supabase.storage
          .from('imagcar')
          .upload(filePath, newFile, { upsert: false })
        if (uploadError) throw uploadError

        const { data: urlData } = supabase.storage.from('imagcar').getPublicUrl(filePath)
        updateObject.imagen_url = urlData.publicUrl

      } catch (error) {
        mostrarMensaje('Error al subir la nueva imagen: ' + error.message, 'red')
        return
      }
    }

    const { error } = await supabase.from('producto')
      .update(updateObject)
      .eq('producto_id', id)

    if (error) return mostrarMensaje('Error al actualizar: ' + error.message, 'red')
    mostrarMensaje('‚úÖ Cambios guardados')
    cargarProductos()
  }

  async function eliminarProducto(id) {
    const { error } = await supabase.from('producto').update({ activo: false }).eq('producto_id', id)
    if (error) return mostrarMensaje('Error al eliminar: ' + error.message, 'red')
    mostrarMensaje('üóëÔ∏è Producto eliminado')
    cargarProductos()
  }

  const editSearch = document.getElementById('edit-search');
  if (editSearch) {
    editSearch.addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase().trim();
      document.querySelectorAll('#productos .producto-item').forEach(card=>{
        const name = card.querySelector('.link-producto')?.textContent.toLowerCase() || '';
        const desc = card.querySelector('textarea')?.value.toLowerCase() || '';
        const match = !q || name.includes(q) || desc.includes(q);
        card.style.display = match ? '' : 'none';
      });
    });
  }

  let audProductoSeleccionado = null;

  async function audBuscar(query) {
    const resultsBox = document.getElementById('aud-search-results');
    if (!query || query.length < 2) {
      resultsBox.style.display = 'none';
      resultsBox.innerHTML = '';
      return;
    }

    const { data, error } = await supabase
      .from('producto')
      .select('producto_id, nombre, stock')
      .ilike('nombre', `%${query}%`)
      .order('nombre')
      .limit(10);

    if (error) {
      console.error(error);
      return;
    }

    if (!data || data.length === 0) {
      resultsBox.innerHTML = '<div class="aud-item">Sin resultados</div>';
      resultsBox.style.display = 'block';
      return;
    }

    resultsBox.innerHTML = data.map(p =>
      `<div class="aud-item" data-id="${p.producto_id}" data-stock="${p.stock}">
         ${p.nombre} (ID: ${p.producto_id})
       </div>`
    ).join('');
    resultsBox.style.display = 'block';
  }

  const audSearchInput = document.getElementById('aud-search');
  if (audSearchInput) {
    audSearchInput.addEventListener('input', (e)=>{
      audBuscar(e.target.value.trim());
    });
  }

  const audResults = document.getElementById('aud-search-results');
  if (audResults) {
    audResults.addEventListener('click', (e)=>{
      const item = e.target.closest('.aud-item');
      if (!item) return;
      const id = Number(item.dataset.id);
      const nombre = item.textContent;
      const stock = item.dataset.stock ?? 0;

      audProductoSeleccionado = id;
      document.getElementById('aud-search').value = nombre;
      audResults.style.display = 'none';

      const formAud = document.getElementById('aud-form');
      formAud.style.display = 'block';
      document.getElementById('aud-stock-sistema').value = stock;
    });
  }

  const btnGuardarAud = document.getElementById('btn-guardar-auditoria');
  if (btnGuardarAud) {
    btnGuardarAud.addEventListener('click', async ()=>{
      if (!audProductoSeleccionado) {
        alert('Primero selecciona un producto para la auditor√≠a.');
        return;
      }

      const semana = document.getElementById('aud-semana').value.trim();
      const stock_sistema = Number(document.getElementById('aud-stock-sistema').value || 0);
      const stock_fisico = Number(document.getElementById('aud-stock-fisico').value || 0);
      const compra = Number(document.getElementById('aud-compra').value || 0);
      const venta = Number(document.getElementById('aud-venta').value || 0);
      const auditoria_ajuste = Number(document.getElementById('aud-ajuste').value || 0);
      const stock_minimo = Number(document.getElementById('aud-minimo').value || 0);
      const observacion = document.getElementById('aud-observacion').value.trim() || null;
      const precio_compra = Number(document.getElementById('aud-precio-compra').value || 0);
      const precio_venta  = Number(document.getElementById('aud-precio-venta').value || 0);

      if (!semana) {
        alert('Ingresa la semana de la auditor√≠a (ej: sem1).');
        return;
      }

      const { error } = await supabase
        .from('producto_auditoria')
        .insert({
          producto_id: audProductoSeleccionado,
          semana,
          stock_sistema,
          stock_fisico,
          compra,
          venta,
          auditoria_ajuste,
          stock_minimo,
          observacion,
          precio_compra,
          precio_venta
        });

      if (error) {
        console.error(error);
        mostrarMensaje('Error al guardar auditor√≠a: ' + error.message, 'red');
        return;
      }

      mostrarMensaje('‚úÖ Auditor√≠a registrada correctamente');

      document.getElementById('aud-semana').value = '';
      document.getElementById('aud-stock-fisico').value = '';
      document.getElementById('aud-compra').value = 0;
      document.getElementById('aud-venta').value = 0;
      document.getElementById('aud-ajuste').value = 0;
      document.getElementById('aud-minimo').value = 0;
      document.getElementById('aud-observacion').value = '';
      document.getElementById('aud-precio-compra').value = 0;
      document.getElementById('aud-precio-venta').value = 0;
    });
  }

  cargarProductos();
</script>
</body>
</html>

