// js/pedido_detalle.js
import { supabase } from "./supabaseClient.js";

const params = new URLSearchParams(window.location.search);
const pedidoID = Number(params.get("id"));

const qs = (s) => document.querySelector(s);
const fmtCLP = (v) =>
  new Intl.NumberFormat("es-CL", {
    style: "currency",
    currency: "CLP",
    maximumFractionDigits: 0,
  }).format(v ?? 0);

let pedidoGlobal = null;
let itemsGlobal = [];

document.addEventListener("DOMContentLoaded", async () => {
  const cont = qs("#detalle");
  if (!cont) return;

  if (!pedidoID) {
    cont.innerHTML = `<p>ID de pedido inv√°lido.</p>`;
    return;
  }

  try {
    // 1) Traer pedido
    const { data: pedido, error: errPedido } = await supabase
      .from("pedido")
      .select("*")
      .eq("pedido_id", pedidoID)
      .single();

    if (errPedido || !pedido) {
      console.error("Error pedido:", errPedido);
      cont.innerHTML = `<p>No se pudo cargar el pedido.</p>`;
      return;
    }
    pedidoGlobal = pedido;

    // 2) Traer items del pedido
    const { data: items, error: errItems } = await supabase
      .from("pedido_item")
      .select("*")
      .eq("pedido_id", pedidoID);

    if (errItems) {
      console.error("Error items:", errItems);
      cont.innerHTML = `<p>No se pudieron cargar los productos del pedido.</p>`;
      return;
    }

    if (!items || !items.length) {
      cont.innerHTML = `<p>Este pedido no tiene productos asociados.</p>`;
      return;
    }
    itemsGlobal = items;

    // 3) Traer info de productos
    const ids = [...new Set(items.map((i) => i.producto_id))];

    const { data: productos, error: errProd } = await supabase
      .from("producto")
      .select("producto_id, nombre, imagen_url, unidad")
      .in("producto_id", ids);

    if (errProd) {
      console.error("Error productos:", errProd);
    }

    const mapProd = {};
    (productos || []).forEach((p) => {
      mapProd[p.producto_id] = p;
    });

    // 4) Renderizar detalle
    cont.innerHTML = `
      <div class="pedido-box">
        <h2>üßæ Pedido #${pedidoID}</h2>
        <p><strong>Fecha:</strong> ${new Date(
          pedido.fecha
        ).toLocaleString()}</p>
        <p><strong>Estado:</strong> <span id="estado-detalle">${
          pedido.estado ?? "‚Äî"
        }</span></p>
        <p><strong>Total:</strong> ${fmtCLP(pedido.total)}</p>
        <hr>

        <h3>Productos del pedido:</h3>

        ${items
          .map((i) => {
            const p = mapProd[i.producto_id] ?? {};
            return `
              <div class="item">
                <img src="${
                  p.imagen_url || "img/placeholder.jpg"
                }" alt="${(p.nombre || "Producto").replace(/"/g, "&quot;")}">
                <div class="item-info">
                  <div class="item-name">${p.nombre || "Producto"}</div>
                  <div class="item-qty">
                    Cantidad: <strong>${i.cantidad}</strong> ${
              p.unidad || ""
            }
                  </div>
                  <div class="item-price">
                    Subtotal: <strong>${fmtCLP(i.total_linea || 0)}</strong>
                  </div>
                </div>
              </div>
            `;
          })
          .join("")}
      </div>
    `;

    // 5) Configurar panel solo para empleados
    configurarPanelEstadoEmpleado(pedidoGlobal);
  } catch (err) {
    console.error("Error general en detalle de pedido:", err);
    cont.innerHTML = `<p>‚ùå Ocurri√≥ un error al cargar el detalle del pedido.</p>`;
  }

  // 6) Bot√≥n boleta PDF
  const btnBoleta = qs("#btnBoleta");
  if (btnBoleta) {
    btnBoleta.addEventListener("click", generarBoletaPDF);
  }
});

// ===============================
// PANEL DE ESTADO PARA EMPLEADO
// ===============================

function configurarPanelEstadoEmpleado(pedido) {
  const panel = qs("#panel-estado-empleado");
  if (!panel) return;

  const rol = localStorage.getItem("rol"); // 1 = cliente, 2 = empleado
  const esEmpleado = rol === "2";

  // Mostrar estado actual en el panel
  const spanEstadoActual = qs("#estado-actual-text");
  if (spanEstadoActual) {
    spanEstadoActual.textContent = pedido.estado || "‚Äî";
  }

  // Si NO es empleado ‚Üí ocultar panel
  if (!esEmpleado) {
    panel.style.display = "none";
    return;
  }

  // Excluir pedidos "Pendiente" (pendiente de pago)
  const estadoLower = (pedido.estado || "").toLowerCase();
  const esPendientePago =
    estadoLower === "pendiente" ||
    estadoLower === "pendiente de pago" ||
    (estadoLower.startsWith("pendiente") &&
      !estadoLower.includes("env√≠o") &&
      !estadoLower.includes("envio"));

  if (esPendientePago) {
    panel.style.display = "none";
    return;
  }

  // Si pasa todo lo anterior ‚Üí mostrar panel
  panel.style.display = "block";

  // Delegaci√≥n de eventos en los botones
  panel.addEventListener("click", async (e) => {
    const btn = e.target.closest(".estado-btn[data-estado]");
    if (!btn) return;

    const nuevoEstado = btn.dataset.estado;
    if (!nuevoEstado) return;

    const textoOriginal = btn.textContent;
    btn.disabled = true;
    btn.textContent = "Guardando...";

    const { error } = await supabase
      .from("pedido")
      .update({ estado: nuevoEstado })
      .eq("pedido_id", pedidoID);

    btn.disabled = false;
    btn.textContent = textoOriginal;

    if (error) {
      console.error("Error actualizando estado:", error);
      if (window.Swal) {
        Swal.fire(
          "Error",
          "No se pudo actualizar el estado del pedido.",
          "error"
        );
      } else {
        alert("No se pudo actualizar el estado del pedido.");
      }
      return;
    }

    // Actualizar en memoria y en la vista
    pedidoGlobal.estado = nuevoEstado;

    const spanEstadoDetalle = qs("#estado-detalle");
    if (spanEstadoDetalle) spanEstadoDetalle.textContent = nuevoEstado;

    const spanEstadoActual2 = qs("#estado-actual-text");
    if (spanEstadoActual2) spanEstadoActual2.textContent = nuevoEstado;

    if (window.Swal) {
      Swal.fire(
        "Estado actualizado",
        "El estado del pedido se ha modificado correctamente.",
        "success"
      );
    }
  });
}

// ===============================
// GENERAR BOLETA PDF
// ===============================

async function generarBoletaPDF() {
  if (!pedidoGlobal || !itemsGlobal.length) {
    alert("No hay datos del pedido para generar la boleta.");
    return;
  }

  if (!window.jspdf) {
    alert("La librer√≠a jsPDF no est√° disponible.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  const colorPrincipal = [139, 0, 0]; // rojo carne

  // Encabezado
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(22);
  pdf.setTextColor(colorPrincipal[0], colorPrincipal[1], colorPrincipal[2]);
  pdf.text("Carnes Ttami√±a", 20, 20);

  pdf.setFontSize(12);
  pdf.setFont("helvetica", "normal");
  pdf.setTextColor(0, 0, 0);
  pdf.text("Boleta de compra", 20, 30);

  // Datos del pedido
  const fecha = new Date(pedidoGlobal.fecha).toLocaleString("es-CL");
  pdf.text(`Pedido N¬∞: ${pedidoGlobal.pedido_id || pedidoID}`, 20, 45);
  pdf.text(`Fecha: ${fecha}`, 20, 52);
  pdf.text(`Estado: ${pedidoGlobal.estado || "-"}`, 20, 59);
  pdf.text(`Total: ${fmtCLP(pedidoGlobal.total)}`, 20, 66);

  // Tabla simple de productos
  let y = 80;
  pdf.setFont("helvetica", "bold");
  pdf.text("Producto", 20, y);
  pdf.text("Cant.", 100, y);
  pdf.text("Total", 150, y);
  pdf.setFont("helvetica", "normal");

  y += 8;

  itemsGlobal.forEach((it) => {
    const lineaTotal = it.total_linea ?? 0;
    pdf.text(`ID ${it.producto_id}`, 20, y);
    pdf.text(String(it.cantidad ?? 0), 105, y);
    pdf.text(`$${Number(lineaTotal).toLocaleString("es-CL")}`, 150, y, {
      align: "right",
    });
    y += 8;
  });

  // Total al final
  y += 10;
  pdf.setFont("helvetica", "bold");
  pdf.setTextColor(colorPrincipal[0], colorPrincipal[1], colorPrincipal[2]);
  pdf.text(
    `TOTAL: $${Number(pedidoGlobal.total || 0).toLocaleString("es-CL")}`,
    20,
    y
  );

  pdf.save(`Boleta_Pedido_${pedidoID}.pdf`);
}
