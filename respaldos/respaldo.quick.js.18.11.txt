  // === BOT√ìN PAGAR (versi√≥n completa con Supabase Auth) ===
  document.getElementById('btnPagar').addEventListener('click', async () => {
    const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    if (carrito.length === 0) {
      alert("Tu carrito est√° vac√≠o üòÖ");
      return;
    }

    const total = carrito.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);

    // 1Ô∏è‚É£ Obtener usuario autenticado
    const { data: authData, error: authError } = await supabase.auth.getUser();
    if (authError || !authData.user) {
      alert("Debes iniciar sesi√≥n antes de comprar üîí");
      return;
    }

    const userId = authData.user.id;

    // 2Ô∏è‚É£ Obtener cliente_id desde tabla usuario
    const { data: usuarioData, error: usuarioError } = await supabase
      .from('usuario')
      .select('cliente_id')
      .eq('auth_user_id', userId)
      .single();

    if (usuarioError || !usuarioData) {
      console.error("Error al obtener cliente_id:", usuarioError?.message);
      alert("No se encontr√≥ tu cliente asociado. Contacta soporte.");
      return;
    }

    const clienteId = usuarioData.cliente_id;

    // 3Ô∏è‚É£ Crear pedido
    const { data: pedido, error: pedidoError } = await supabase
      .from('pedido')
      .insert([{
        cliente_id: clienteId,
        metodo_pago: 'simulado',
        estado: 'pendiente',
        total: total,
        fecha: new Date()
      }])
      .select()
      .single();

    if (pedidoError) {
      console.error("Error al crear pedido:", pedidoError.message);
      alert("‚ùå Ocurri√≥ un error al procesar tu compra.");
      return;
    }

    // 4Ô∏è‚É£ Insertar √≠tems del pedido
    for (const item of carrito) {
      const { error: itemError } = await supabase
        .from('pedido_item')
        .insert([{
          pedido_id: pedido.pedido_id,
          producto_id: item.producto_id,
          cantidad: item.cantidad,
          precio_unitario: item.precio,
          total_linea: item.precio * item.cantidad
        }]);
      if (itemError) console.error("Error al insertar √≠tem:", itemError.message);
    }

    // 5Ô∏è‚É£ Vaciar carrito y confirmar
    localStorage.removeItem('carrito');
    alert("‚úÖ ¬°Pedido registrado correctamente! Gracias por tu compra üí™");
    window.location.href = "pag_principal.html";
  });
