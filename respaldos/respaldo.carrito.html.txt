<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tu Carrito - Carnes Ttami√±a</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="css/footer.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script type="module" src="js/navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module" src="js/searchbar.js"></script>

</head>

<body>
<!-- NAVBAR -->
<header class="navbar">
  <div class="navbar-container">
    <div class="navbar-left">
      <h1 class="navbar-logo">Carnes Ttami√±a</h1>
      <div class="navbar-search">
        <input type="text" placeholder="Busca aqu√≠ tus productos..." />
        <button><i class="fa fa-search"></i></button>
      </div>
    </div>

    <nav class="navbar-right">
      <ul>
        <li><a href="pag_principal.html"><i class="fa fa-home"></i> Inicio</a></li>

        <li class="dropdown align-right">
          <a href="#"><i class="fa fa-user"></i> Bienvenido</a>
          <ul class="dropdown-menu">
            <li><a href="#"><i class="fa fa-id-card"></i> Mi cuenta</a></li>
            <li><a href="login.html"><i class="fa fa-sign-in-alt"></i> Iniciar sesi√≥n</a></li>
            <li class="no-cuenta">¬øNo tienes cuenta?
              <a href="registro.html" class="crear-cuenta">Cr√©ala aqu√≠</a>
            </li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#"><i class="fa fa-cut"></i> Categor√≠as <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu">
            <li><a href="vacuno.html">Vacuno</a></li>
            <li><a href="ave.html">Ave</a></li>
            <li><a href="cerdo.html">Cerdo</a></li>
            <li><a href="todo_asado.html">Todo para el asado</a></li>
            <li><a href="packs.html">Packs</a></li>
          </ul>
        </li>

        <li class="cart-icon">
          <a href="carrito.html">
            <i class="fa fa-shopping-cart"></i>
            <span class="cart-count">0</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>

<!-- CUERPO DEL CARRITO -->
<main style="padding: 20px;">
  <table class="tabla-carrito">
    <thead>
      <tr>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Precio</th>
        <th>Subtotal</th>
        <th></th>
      </tr>
    </thead>
    <tbody class="carrito-body"></tbody>
  </table>

  <h3>Total: <span id="total">$0</span></h3>

  <button id="btnPagar" style="
    background:#2e7d32;
    color:#fff;
    border:none;
    border-radius:8px;
    padding:10px 20px;
    font-weight:600;
    cursor:pointer;
    margin-top:10px;
  ">üí≥ Pagar ahora</button>

  <button id="vaciarCarrito" style="
    background:#8b0000;
    color:#fff;
    border:none;
    border-radius:8px;
    padding:10px 20px;
    font-weight:600;
    cursor:pointer;
    margin-top:10px;
  ">üóëÔ∏è Vaciar carrito</button>

  <a id="volverTienda" href="pag_principal.html" style="
    text-decoration:none;
    display:inline-block;
    padding:10px 12px;
    border-radius:8px;
    background:#b71c1c;
    color:#fff;
    font-weight:600;
    margin-left:5px;
  ">‚Üê Volver a la tienda</a>
</main>

<footer class="footer">
  <div class="footer-container">

    <!-- CATEGOR√çAS -->
    <div class="footer-block">
      <h3>Categor√≠as</h3>
      <ul>
        <li><a href="vacuno.html">Vacuno</a></li>
        <li><a href="ave.html">Ave</a></li>
        <li><a href="cerdo.html">Cerdo</a></li>
        <li><a href="todo_asado.html">Todo Asado</a></li>
        <li><a href="packs.html">Packs</a></li>
      </ul>
    </div>

    <!-- SERVICIO AL CLIENTE -->
    <div class="footer-block">
      <h3>Servicio al cliente</h3>
      <ul>
        <li><a href="#">Qui√©nes somos</a></li>
        <li class="phone">üìû +56 9 1234 5678</li>
        <li class="social-icons">
          <!-- gente yo no se si manejan redes la carniceria pero si quieren los quitan -->
          <a href="#"><i class="fa-brands fa-facebook"></i></a>
          <a href="#"><i class="fa-brands fa-instagram"></i></a>
          <a href="#"><i class="fa-brands fa-whatsapp"></i></a>
        </li>
      </ul>
    </div>

    <!-- HORARIOS -->
    <div class="footer-block">
      <h3>Horarios</h3>
      <p>De Martes a Domingo:<br>De 09:00 hasta las 15:00 por colaci√≥n <br> Luego reabre desde las 16:30 <br> hasta las 21:00 de la noche </p>
    </div>

    <!-- M√âTODOS DE PAGO -->
    <div class="footer-block">
      <h3>M√©todos de pago</h3>
      <img src="img/webpay.png" alt="WebPay Plus" class="webpay-logo">
    </div>

  </div>

  <div class="footer-legal">
    Pagos seguros v√≠a WebPay Plus. Despachos seg√∫n disponibilidad del repartidor.
  </div>
</footer>

<!-- SCRIPTS -->
<script type="module">
  import { supabase } from './js/supabaseClient.js';
  import { actualizarContadorCarrito } from './js/carritoglobal.js';

  document.addEventListener('DOMContentLoaded', () => {
    mostrarCarrito();
    actualizarContadorCarrito();
  });

  function mostrarCarrito() {
    const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    const contenedor = document.querySelector('.carrito-body');
    const totalElem = document.getElementById('total');

    contenedor.innerHTML = '';

    if (carrito.length === 0) {
      contenedor.innerHTML = `
        <tr>
          <td colspan="4" style="text-align:center; padding:20px;">
            üõí Tu carrito est√° vac√≠o.
          </td>
        </tr>`;
      totalElem.textContent = '$0';
      return;
    }

    let total = 0;
    carrito.forEach((item, i) => {
      const subtotal = item.precio * item.cantidad;
      total += subtotal;

      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td>${item.nombre}</td>
        <td>
          <input type="number" value="${item.cantidad}" min="1" 
                 data-index="${i}" class="input-cantidad" style="width:60px;">
        </td>
        <td>${item.precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' })}</td>
        <td>${subtotal.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' })}</td>
        <td><button class="btn-eliminar" data-index="${i}">üóëÔ∏è</button></td>
      `;
      contenedor.appendChild(fila);
    });

    totalElem.textContent = total.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });

    document.querySelectorAll('.input-cantidad').forEach(input => {
      input.addEventListener('change', actualizarCantidad);
    });

    document.querySelectorAll('.btn-eliminar').forEach(btn => {
      btn.addEventListener('click', eliminarProducto);
    });
  }

  function actualizarCantidad(e) {
    const index = e.target.dataset.index;
    const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    carrito[index].cantidad = parseInt(e.target.value) || 1;
    localStorage.setItem('carrito', JSON.stringify(carrito));
    mostrarCarrito();
  }

  function eliminarProducto(e) {
    const index = e.target.dataset.index;
    const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    carrito.splice(index, 1);
    localStorage.setItem('carrito', JSON.stringify(carrito));
    mostrarCarrito();
  }

  document.getElementById('vaciarCarrito').addEventListener('click', () => {
    localStorage.removeItem('carrito');
    mostrarCarrito();
  });

  // === BOT√ìN PAGAR (versi√≥n completa con Supabase Auth) ===
  document.getElementById('btnPagar').addEventListener('click', async () => {
    const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    if (carrito.length === 0) {
      alert("Tu carrito est√° vac√≠o üòÖ");
      return;
    }

    const total = carrito.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);

    // 1Ô∏è‚É£ Obtener usuario autenticado
    const { data: authData, error: authError } = await supabase.auth.getUser();
    if (authError || !authData.user) {
      alert("Debes iniciar sesi√≥n antes de comprar üîí");
      return;
    }

    const userId = authData.user.id;

    // 2Ô∏è‚É£ Obtener cliente_id desde tabla usuario
    const { data: usuarioData, error: usuarioError } = await supabase
      .from('usuario')
      .select('cliente_id')
      .eq('auth_user_id', userId)
      .single();

    if (usuarioError || !usuarioData) {
      console.error("Error al obtener cliente_id:", usuarioError?.message);
      alert("No se encontr√≥ tu cliente asociado. Contacta soporte.");
      return;
    }

    const clienteId = usuarioData.cliente_id;

    // 3Ô∏è‚É£ Crear pedido
    const { data: pedido, error: pedidoError } = await supabase
      .from('pedido')
      .insert([{
        cliente_id: clienteId,
        metodo_pago: 'simulado',
        estado: 'pendiente',
        total: total,
        fecha: new Date()
      }])
      .select()
      .single();

    if (pedidoError) {
      console.error("Error al crear pedido:", pedidoError.message);
      alert("‚ùå Ocurri√≥ un error al procesar tu compra.");
      return;
    }

    // 4Ô∏è‚É£ Insertar √≠tems del pedido
    for (const item of carrito) {
      const { error: itemError } = await supabase
        .from('pedido_item')
        .insert([{
          pedido_id: pedido.pedido_id,
          producto_id: item.producto_id,
          cantidad: item.cantidad,
          precio_unitario: item.precio,
          total_linea: item.precio * item.cantidad
        }]);
      if (itemError) console.error("Error al insertar √≠tem:", itemError.message);
    }

    // 5Ô∏è‚É£ Vaciar carrito y confirmar
    localStorage.removeItem('carrito');
    alert("‚úÖ ¬°Pedido registrado correctamente! Gracias por tu compra üí™");
    window.location.href = "pag_principal.html";
  });
</script>

</body>
</html>